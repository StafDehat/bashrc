#!/bin/bash

#
# List all users on the given cloud account

function usage() {
  echo "Usage: brc-identity-listusers [-t BRC_TENANTID] [-a BRC_AUTHTOKEN]"
  echo "Example:"
  echo "  # brc-identity-listusers -t 123456 -a 1a2b3c4d5e6f7g8h9i0j"
  echo "Example:"
  echo "  # export BRC_TENANTID=123456"
  echo "  # export BRC_AUTHTOKEN=1a2b3c4d5e6f7g8h9i0j"
  echo "  # brc-identity-listusers"
}

while getopts ":ht:a:" arg; do
  case $arg in
    t) BRC_TENANTID=$OPTARG;;
    a) BRC_AUTHTOKEN=$OPTARG;;
    *) usage && exit 1;;
  esac
done #End arguments
shift $(($OPTIND - 1))

if [ -z $BRC_TENANTID ]; then
  echo "ERROR: Must define BRC_TENANTID in environment or argument"
  usage && exit 1
elif [ -z $BRC_AUTHTOKEN ]; then
  echo "ERROR: Must define BRC_AUTHTOKEN in environment or argument"
  usage && exit 1
fi

ENDPOINT=$IDENTITY_ENDPOINT
USERDATA=$( curl $ENDPOINT/users \
                 -H "Content-Type: application/json" \
                 -H "X-Auth-Token: $BRC_AUTHTOKEN" \
              2>/dev/null | brc-json.tool )

USERIDS=$( echo "$USERDATA" \
             | sed -n 's/bashrc~users~username.\([0-9]*\)~.*$/\1/p' )

# Just clean up the output a bit
echo ---
for x in $USERIDS; do
  echo "$USERDATA" | grep "\.$x~"
  echo ---
done
